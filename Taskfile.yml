version: "3"

vars:
  BASE_DIR: "{{.ROOT_DIR}}"
  LOG_DIR: "{{.ROOT_DIR}}/logs"

  # Inator registry â€” add new inators here
  # Format: name:backend_port:frontend_port
  INATORS: >-
    authinator:8001:3001
    rmainator:8002:3002
    fulfilinator:8003:3003

  # Directory names (capitalized) â€” must match filesystem
  AUTHINATOR_DIR: Authinator
  RMAINATOR_DIR: RMAinator
  FULFILINATOR_DIR: Fulfilinator

set: [errexit, nounset, pipefail]

tasks:
  default:
    desc: List available tasks
    silent: true
    cmds:
      - task --list

  # â”€â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  setup:
    desc: First-time setup for all inators (install deps, configure env, migrate)
    cmds:
      - task: setup:authinator
      - task: setup:rmainator
      - task: setup:fulfilinator
      - task: setup:admin
      - echo ""
      - echo "âœ… Setup complete! All inators are ready."
      - echo ""
      - echo "Next steps:"
      - echo "  1. Start all services:"
      - echo "     task start:all"
      - echo "  2. Access the platform"
      - echo "     Gateway (unified) - http://localhost:8080"
      - echo ""

  setup:authinator:
    desc: Setup Authinator
    cmds:
      - task: _setup
        vars: { NAME: Authinator, DIR: "{{.AUTHINATOR_DIR}}" }

  setup:rmainator:
    desc: Setup RMAinator
    cmds:
      - task: _setup
        vars: { NAME: RMAinator, DIR: "{{.RMAINATOR_DIR}}" }

  setup:fulfilinator:
    desc: Setup Fulfilinator
    cmds:
      - task: _setup
        vars: { NAME: Fulfilinator, DIR: "{{.FULFILINATOR_DIR}}" }

  _setup:
    internal: true
    requires:
      vars: [NAME, DIR]
    cmds:
      - echo "ğŸ”§ Setting up {{.NAME}}..."
      - cd "{{.BASE_DIR}}/{{.DIR}}" && task install
      - |
        if [ ! -f "{{.BASE_DIR}}/{{.DIR}}/backend/.env" ]; then
          echo "   Creating backend/.env from .env.example"
          cp "{{.BASE_DIR}}/{{.DIR}}/backend/.env.example" "{{.BASE_DIR}}/{{.DIR}}/backend/.env"
        else
          echo "   backend/.env already exists, skipping"
        fi
      - echo "   Running migrations..."
      - cd "{{.BASE_DIR}}/{{.DIR}}" && task backend:migrate
      - echo "âœ“ {{.NAME}} setup complete"
      - echo ""

  setup:admin:
    desc: Create a default admin user in Authinator (interactive)
    cmds:
      - |
        echo ""
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "  Admin User Setup"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
        printf "Create a default admin user? (admin / admin@example.com / admin123) [Y/n] "
        read -r answer </dev/tty
        case "$answer" in
          [nN]*)
            echo "Skipping admin creation."
            echo "You can create one later with:"
            echo "  cd Authinator && task backend:manage -- createsuperuser"
            ;;
          *)
            DJANGO_SUPERUSER_PASSWORD=admin123 \
              "{{.BASE_DIR}}/{{.AUTHINATOR_DIR}}/.venv/bin/python" \
              "{{.BASE_DIR}}/{{.AUTHINATOR_DIR}}/backend/manage.py" \
              createsuperuser --noinput --username admin --email admin@example.com 2>&1 \
            && echo "âœ“ Admin user created (admin / admin123)" \
            || echo "âš  Admin user already exists, skipping"
            ;;
        esac

  # â”€â”€â”€ Unified Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  frontend:install:
    desc: Install unified frontend dependencies
    cmds:
      - cd "{{.BASE_DIR}}/frontend" && task install

  frontend:dev:
    desc: Start unified frontend dev server (:5173)
    cmds:
      - cd "{{.BASE_DIR}}/frontend" && task dev

  frontend:build:
    desc: Build unified frontend for production
    cmds:
      - cd "{{.BASE_DIR}}/frontend" && task build

  frontend:check:
    desc: Run pre-commit checks on unified frontend
    cmds:
      - cd "{{.BASE_DIR}}/frontend" && task check

  frontend:start:
    desc: Start unified frontend dev server (background, :5173)
    cmds:
      - mkdir -p "{{.LOG_DIR}}"
      - |
        echo "â–¶ï¸  Starting unified frontend (:5173)..."
        cd "{{.BASE_DIR}}/frontend"
        nohup npx vite --port 5173 --strictPort \
          < /dev/null > "{{.LOG_DIR}}/frontend.log" 2>&1 &
        echo "   PID: $!"
      - sleep 2

  frontend:stop:
    desc: Stop unified frontend dev server
    cmds:
      - |
        echo "â¹  Stopping unified frontend..."
        pkill -f "vite.*5173" 2>/dev/null || true

  # â”€â”€â”€ Gateway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  gateway:start:
    desc: Start Caddy reverse proxy gateway (:8080)
    cmds:
      - mkdir -p "{{.LOG_DIR}}"
      - |
        echo "â–¶ï¸  Starting Caddy gateway (:8080)..."
        nohup caddy run --config "{{.BASE_DIR}}/Caddyfile.dev" \
          > "{{.LOG_DIR}}/gateway.log" 2>&1 &
        echo "   PID: $!"
      - sleep 1

  gateway:stop:
    desc: Stop Caddy reverse proxy gateway
    cmds:
      - |
        echo "â¹  Stopping Caddy gateway..."
        pkill -f "caddy run.*Caddyfile.dev" 2>/dev/null || true

  # â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  start:all:
    desc: Start all backends, unified frontend, gateway, and register services
    cmds:
      - task: _start_backend
        vars: { NAME: Authinator, DIR: "{{.AUTHINATOR_DIR}}", BACKEND_PORT: "8001" }
      - task: _start_backend
        vars: { NAME: RMAinator, DIR: "{{.RMAINATOR_DIR}}", BACKEND_PORT: "8002" }
      - task: _start_backend
        vars: { NAME: Fulfilinator, DIR: "{{.FULFILINATOR_DIR}}", BACKEND_PORT: "8003" }
      - task: frontend:start
      - task: gateway:start
      - task: register
      - task: status

  register:
    desc: Register all services with Authinator (requires services to be running)
    cmds:
      - |
        echo "ğŸ“‹ Registering services with Authinator..."
        cd "{{.BASE_DIR}}/{{.RMAINATOR_DIR}}" && task backend:manage -- register_service 2>/dev/null || echo "   âš  RMAinator registration failed (is Authinator running?)"
        cd "{{.BASE_DIR}}/{{.FULFILINATOR_DIR}}" && task backend:manage -- register_service 2>/dev/null || echo "   âš  Fulfilinator registration failed (is Authinator running?)"

  start:authinator:
    desc: Start Authinator (backend :8001, frontend :3001)
    cmds:
      - task: _start
        vars:
          NAME: Authinator
          DIR: "{{.AUTHINATOR_DIR}}"
          BACKEND_PORT: "8001"
          FRONTEND_PORT: "3001"

  start:rmainator:
    desc: Start RMAinator (backend :8002, frontend :3002)
    cmds:
      - task: _start
        vars:
          NAME: RMAinator
          DIR: "{{.RMAINATOR_DIR}}"
          BACKEND_PORT: "8002"
          FRONTEND_PORT: "3002"

  start:fulfilinator:
    desc: Start Fulfilinator (backend :8003, frontend :3003)
    cmds:
      - task: _start
        vars:
          NAME: Fulfilinator
          DIR: "{{.FULFILINATOR_DIR}}"
          BACKEND_PORT: "8003"
          FRONTEND_PORT: "3003"

  _start_backend:
    internal: true
    requires:
      vars: [NAME, DIR, BACKEND_PORT]
    cmds:
      - mkdir -p "{{.LOG_DIR}}"
      - |
        echo "â–¶ï¸  Starting {{.NAME}} backend (:{{.BACKEND_PORT}})..."
        nohup "{{.BASE_DIR}}/{{.DIR}}/.venv/bin/python" \
          "{{.BASE_DIR}}/{{.DIR}}/backend/manage.py" runserver {{.BACKEND_PORT}} \
          > "{{.LOG_DIR}}/{{.NAME}}-backend.log" 2>&1 &
        echo "   PID: $!"
      - sleep 1

  _start:
    internal: true
    desc: "(legacy) Start both backend and per-inator frontend"
    requires:
      vars: [NAME, DIR, BACKEND_PORT, FRONTEND_PORT]
    cmds:
      - task: _start_backend
        vars: { NAME: "{{.NAME}}", DIR: "{{.DIR}}", BACKEND_PORT: "{{.BACKEND_PORT}}" }
      - |
        echo "â–¶ï¸  Starting {{.NAME}} frontend (:{{.FRONTEND_PORT}})..."
        cd "{{.BASE_DIR}}/{{.DIR}}/frontend"
        nohup npx vite --port {{.FRONTEND_PORT}} --strictPort \
          < /dev/null > "{{.LOG_DIR}}/{{.NAME}}-frontend.log" 2>&1 &
        echo "   PID: $!"
      - sleep 2

  # â”€â”€â”€ Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  stop:all:
    desc: Stop all services, unified frontend, and gateway
    cmds:
      - task: gateway:stop
      - task: frontend:stop
      - task: stop:authinator
      - task: stop:rmainator
      - task: stop:fulfilinator
      - task: status

  stop:authinator:
    desc: Stop Authinator
    cmds:
      - task: _stop
        vars: { NAME: Authinator, BACKEND_PORT: "8001", FRONTEND_PORT: "3001" }

  stop:rmainator:
    desc: Stop RMAinator
    cmds:
      - task: _stop
        vars: { NAME: RMAinator, BACKEND_PORT: "8002", FRONTEND_PORT: "3002" }

  stop:fulfilinator:
    desc: Stop Fulfilinator
    cmds:
      - task: _stop
        vars: { NAME: Fulfilinator, BACKEND_PORT: "8003", FRONTEND_PORT: "3003" }

  _stop:
    internal: true
    requires:
      vars: [NAME, BACKEND_PORT, FRONTEND_PORT]
    cmds:
      - |
        echo "â¹  Stopping {{.NAME}}..."
        pkill -f "manage.py runserver {{.BACKEND_PORT}}" 2>/dev/null || true
        pkill -f "vite.*{{.FRONTEND_PORT}}" 2>/dev/null || true

  # â”€â”€â”€ Restart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  restart:all:
    desc: Restart all inator services
    cmds:
      - task: stop:all
      - sleep 1
      - task: start:all

  restart:authinator:
    desc: Restart Authinator
    cmds:
      - task: stop:authinator
      - sleep 1
      - task: start:authinator

  restart:rmainator:
    desc: Restart RMAinator
    cmds:
      - task: stop:rmainator
      - sleep 1
      - task: start:rmainator

  restart:fulfilinator:
    desc: Restart Fulfilinator
    cmds:
      - task: stop:fulfilinator
      - sleep 1
      - task: start:fulfilinator

  # â”€â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  status:
    desc: Check which inator ports are listening
    silent: true
    cmds:
      - |
        echo ""
        echo "Port status:"
        for port in 8080 5173 8001 3001 8002 3002 8003 3003; do
          if lsof -iTCP:$port -sTCP:LISTEN -P >/dev/null 2>&1; then
            echo "  :$port âœ“"
          else
            echo "  :$port âœ—"
          fi
        done
        echo ""

  # â”€â”€â”€ Demo Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  setup:demodb:
    desc: Build demo databases with sample data (does NOT touch active DBs)
    cmds:
      - |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  Building demo databases"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        for inator_dir in "{{.AUTHINATOR_DIR}}" "{{.RMAINATOR_DIR}}" "{{.FULFILINATOR_DIR}}"; do
          DB="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3"
          DEMO="{{.BASE_DIR}}/$inator_dir/backend/db-demo.sqlite3"
          USER_BAK="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3.demobuild"

          # Stash active DB
          if [ -f "$DB" ]; then
            mv "$DB" "$USER_BAK"
          fi

          echo "ğŸ”§ Migrating $inator_dir..."
          cd "{{.BASE_DIR}}/$inator_dir" && task backend:migrate 2>&1 | tail -1

          # Create admin superuser (Authinator only)
          if [ "$inator_dir" = "{{.AUTHINATOR_DIR}}" ]; then
            echo "   Creating admin superuser..."
            DJANGO_SUPERUSER_PASSWORD=admin123 \
              "{{.BASE_DIR}}/{{.AUTHINATOR_DIR}}/.venv/bin/python" \
              "{{.BASE_DIR}}/{{.AUTHINATOR_DIR}}/backend/manage.py" \
              createsuperuser --noinput --username admin --email admin@example.com 2>/dev/null || true
          fi

          echo "ğŸŒ± Seeding $inator_dir..."
          cd "{{.BASE_DIR}}/$inator_dir" && task backend:manage -- seed_demo

          # Save as demo DB and restore active
          mv "$DB" "$DEMO"
          if [ -f "$USER_BAK" ]; then
            mv "$USER_BAK" "$DB"
          fi
          echo ""
        done
        echo "âœ… Demo databases built!"
        echo ""
        echo "  Authinator: backend/db-demo.sqlite3"
        echo "  RMAinator:  backend/db-demo.sqlite3"
        echo "  Fulfilinator: backend/db-demo.sqlite3"
        echo ""
        echo "Run 'task demodb:activate' to switch to demo data."
        echo "Run 'task demodb:deactivate' to restore your real data."

  demodb:activate:
    desc: Swap active databases to demo data (backs up current DBs)
    cmds:
      - |
        echo "Activating demo databases..."
        for inator_dir in "{{.AUTHINATOR_DIR}}" "{{.RMAINATOR_DIR}}" "{{.FULFILINATOR_DIR}}"; do
          DB="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3"
          DEMO="{{.BASE_DIR}}/$inator_dir/backend/db-demo.sqlite3"
          BAK="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3.bak"

          if [ ! -f "$DEMO" ]; then
            echo "âš  $inator_dir: no demo DB found â€” run 'task setup:demodb' first"
            continue
          fi
          if [ -f "$BAK" ]; then
            echo "âš  $inator_dir: backup already exists â€” already activated?"
            continue
          fi

          if [ -f "$DB" ]; then
            mv "$DB" "$BAK"
          fi
          cp "$DEMO" "$DB"
          echo "âœ“ $inator_dir: demo DB active"
        done
        echo ""
        echo "Demo data is now active. Restart services to pick it up:"
        echo "  task restart:all"
        echo ""
        echo "Login: admin / admin123 (or any demo user with demo123)"

  demodb:deactivate:
    desc: Restore original databases (removes demo swap)
    cmds:
      - |
        echo "Restoring original databases..."
        for inator_dir in "{{.AUTHINATOR_DIR}}" "{{.RMAINATOR_DIR}}" "{{.FULFILINATOR_DIR}}"; do
          DB="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3"
          BAK="{{.BASE_DIR}}/$inator_dir/backend/db.sqlite3.bak"

          if [ ! -f "$BAK" ]; then
            echo "âš  $inator_dir: no backup found â€” demo not active?"
            continue
          fi

          mv "$BAK" "$DB"
          echo "âœ“ $inator_dir: original DB restored"
        done
        echo ""
        echo "Original data restored. Restart services to pick it up:"
        echo "  task restart:all"

  # â”€â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  logs:
    desc: Tail all inator logs
    cmds:
      - tail -f {{.LOG_DIR}}/*.log
