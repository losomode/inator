version: "3"

vars:
  BASE_DIR: "{{.ROOT_DIR}}"
  LOG_DIR: "{{.ROOT_DIR}}/logs"

  # Inator registry â€” add new inators here
  # Format: name:backend_port:frontend_port
  INATORS: >-
    authinator:8001:3001
    rmainator:8002:3002
    fulfilinator:8003:3003

  # Directory names (capitalized) â€” must match filesystem
  AUTHINATOR_DIR: Authinator
  RMAINATOR_DIR: RMAinator
  FULFILINATOR_DIR: Fulfilinator

set: [errexit, nounset, pipefail]

tasks:
  default:
    desc: List available tasks
    silent: true
    cmds:
      - task --list

  # â”€â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  setup:
    desc: First-time setup for all inators (install deps, configure env, migrate)
    cmds:
      - task: setup:authinator
      - task: setup:rmainator
      - task: setup:fulfilinator
      - echo ""
      - echo "âœ… Setup complete! All inators are ready."
      - echo ""
      - echo "Next steps:"
      - echo "  1. Create your admin user:"
      - echo "     cd Authinator && task backend:manage -- createsuperuser && cd .."
      - echo "  2. Start all services:"
      - echo "     task start:all"
      - echo "  3. Access services"
      - echo "     Authinator  - http://localhost:3001"
      - echo "     RMAinator   - http://localhost:3002"
      - echo "     Fulfilinator - http://localhost:3003"
      - echo ""

  setup:authinator:
    desc: Setup Authinator
    cmds:
      - task: _setup
        vars: { NAME: Authinator, DIR: "{{.AUTHINATOR_DIR}}" }

  setup:rmainator:
    desc: Setup RMAinator
    cmds:
      - task: _setup
        vars: { NAME: RMAinator, DIR: "{{.RMAINATOR_DIR}}" }

  setup:fulfilinator:
    desc: Setup Fulfilinator
    cmds:
      - task: _setup
        vars: { NAME: Fulfilinator, DIR: "{{.FULFILINATOR_DIR}}" }

  _setup:
    internal: true
    requires:
      vars: [NAME, DIR]
    cmds:
      - echo "ğŸ”§ Setting up {{.NAME}}..."
      - cd "{{.BASE_DIR}}/{{.DIR}}" && task install
      - |
        if [ ! -f "{{.BASE_DIR}}/{{.DIR}}/backend/.env" ]; then
          echo "   Creating backend/.env from .env.example"
          cp "{{.BASE_DIR}}/{{.DIR}}/backend/.env.example" "{{.BASE_DIR}}/{{.DIR}}/backend/.env"
        else
          echo "   backend/.env already exists, skipping"
        fi
      - echo "   Running migrations..."
      - cd "{{.BASE_DIR}}/{{.DIR}}" && task backend:migrate
      - echo "âœ“ {{.NAME}} setup complete"
      - echo ""

  # â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  start:all:
    desc: Start all inator services and register with Authinator
    cmds:
      - task: start:authinator
      - task: start:rmainator
      - task: start:fulfilinator
      - task: register
      - task: status

  register:
    desc: Register all services with Authinator (requires services to be running)
    cmds:
      - |
        echo "ğŸ“‹ Registering services with Authinator..."
        cd "{{.BASE_DIR}}/{{.RMAINATOR_DIR}}" && task backend:manage -- register_service 2>/dev/null || echo "   âš  RMAinator registration failed (is Authinator running?)"
        cd "{{.BASE_DIR}}/{{.FULFILINATOR_DIR}}" && task backend:manage -- register_service 2>/dev/null || echo "   âš  Fulfilinator registration failed (is Authinator running?)"

  start:authinator:
    desc: Start Authinator (backend :8001, frontend :3001)
    cmds:
      - task: _start
        vars:
          NAME: Authinator
          DIR: "{{.AUTHINATOR_DIR}}"
          BACKEND_PORT: "8001"
          FRONTEND_PORT: "3001"

  start:rmainator:
    desc: Start RMAinator (backend :8002, frontend :3002)
    cmds:
      - task: _start
        vars:
          NAME: RMAinator
          DIR: "{{.RMAINATOR_DIR}}"
          BACKEND_PORT: "8002"
          FRONTEND_PORT: "3002"

  start:fulfilinator:
    desc: Start Fulfilinator (backend :8003, frontend :3003)
    cmds:
      - task: _start
        vars:
          NAME: Fulfilinator
          DIR: "{{.FULFILINATOR_DIR}}"
          BACKEND_PORT: "8003"
          FRONTEND_PORT: "3003"

  _start:
    internal: true
    requires:
      vars: [NAME, DIR, BACKEND_PORT, FRONTEND_PORT]
    cmds:
      - mkdir -p "{{.LOG_DIR}}"
      - |
        echo "â–¶ï¸  Starting {{.NAME}} backend (:{{.BACKEND_PORT}})..."
        nohup "{{.BASE_DIR}}/{{.DIR}}/.venv/bin/python" \
          "{{.BASE_DIR}}/{{.DIR}}/backend/manage.py" runserver {{.BACKEND_PORT}} \
          > "{{.LOG_DIR}}/{{.NAME}}-backend.log" 2>&1 &
        echo "   PID: $!"
      - |
        echo "â–¶ï¸  Starting {{.NAME}} frontend (:{{.FRONTEND_PORT}})..."
        cd "{{.BASE_DIR}}/{{.DIR}}/frontend"
        nohup npx vite --port {{.FRONTEND_PORT}} --strictPort \
          < /dev/null > "{{.LOG_DIR}}/{{.NAME}}-frontend.log" 2>&1 &
        echo "   PID: $!"
      - sleep 2

  # â”€â”€â”€ Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  stop:all:
    desc: Stop all inator services
    cmds:
      - task: stop:authinator
      - task: stop:rmainator
      - task: stop:fulfilinator
      - task: status

  stop:authinator:
    desc: Stop Authinator
    cmds:
      - task: _stop
        vars: { NAME: Authinator, BACKEND_PORT: "8001", FRONTEND_PORT: "3001" }

  stop:rmainator:
    desc: Stop RMAinator
    cmds:
      - task: _stop
        vars: { NAME: RMAinator, BACKEND_PORT: "8002", FRONTEND_PORT: "3002" }

  stop:fulfilinator:
    desc: Stop Fulfilinator
    cmds:
      - task: _stop
        vars: { NAME: Fulfilinator, BACKEND_PORT: "8003", FRONTEND_PORT: "3003" }

  _stop:
    internal: true
    requires:
      vars: [NAME, BACKEND_PORT, FRONTEND_PORT]
    cmds:
      - |
        echo "â¹  Stopping {{.NAME}}..."
        pkill -f "manage.py runserver {{.BACKEND_PORT}}" 2>/dev/null || true
        pkill -f "vite.*{{.FRONTEND_PORT}}" 2>/dev/null || true

  # â”€â”€â”€ Restart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  restart:all:
    desc: Restart all inator services
    cmds:
      - task: stop:all
      - sleep 1
      - task: start:all

  restart:authinator:
    desc: Restart Authinator
    cmds:
      - task: stop:authinator
      - sleep 1
      - task: start:authinator

  restart:rmainator:
    desc: Restart RMAinator
    cmds:
      - task: stop:rmainator
      - sleep 1
      - task: start:rmainator

  restart:fulfilinator:
    desc: Restart Fulfilinator
    cmds:
      - task: stop:fulfilinator
      - sleep 1
      - task: start:fulfilinator

  # â”€â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  status:
    desc: Check which inator ports are listening
    silent: true
    cmds:
      - |
        echo ""
        echo "Port status:"
        for port in 8001 3001 8002 3002 8003 3003; do
          if lsof -iTCP:$port -sTCP:LISTEN -P >/dev/null 2>&1; then
            echo "  :$port âœ“"
          else
            echo "  :$port âœ—"
          fi
        done
        echo ""

  # â”€â”€â”€ Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  logs:
    desc: Tail all inator logs
    cmds:
      - tail -f {{.LOG_DIR}}/*.log
